{% if current_user.is_authenticated %}
    {% include 'navbar_logged_in.html' %}
  {% else %}
    {% include 'navbar_logged_out.html' %}
{% endif %}
{% block content %}
<script src="{{ url_for('static', filename='renderDirections.js') }}"></script>

<!-- Left Column Travel Details  -->
<div class="col-sm-3" id="info">

  <div class="panel-group" id="accordion">

    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">
            <button id="biking_button" type="button" class="btn btn-secondary btn-lg btn-block">
              <h4 style="display:inline"><strong>&nbsp;Dublin Bikes</strong></h4>
              <p style="display:inline" id="totalBikeTime"></p>
            </button>
          </a>
        </h4>
      </div>
      <div id="collapse1" class="panel-collapse collapse biking">
        <div class="panel-body">
          <div id="bikeLeg1">
          </div>
          <div id="bikeLeg2">
          </div>
          <div id="bikeLeg3">
          </div>
        </div>
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a data-toggle="collapse" data-parent="#accordion" href="#collapse2">
            <button id="walking_button" type="button" class="btn btn-secondary btn-lg btn-block">
              <h4 style="display:inline"><strong>&nbsp;Walking</strong></h4>
              <p style="display:inline" id="totalWalkTime"></p>
            </button>
          </a>
        </h4>
      </div>
      <div id="collapse2" class="panel-collapse collapse">
        <div class="panel-body">
          <div id="walkLeg">
          </div>
        </div>
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">
          <a data-toggle="collapse" data-parent="#accordion" href="#collapse3">
            <button id="transit_button" type="button" class="btn btn-secondary btn-lg btn-block">
              <h4 style="display:inline"><strong>&nbsp;Public Transport</strong></h4>
              <p style="display:inline" id="totalTransitTime"></p>
            </button>
          </a>
        </h4>
      </div>
      <div id="collapse3" class="panel-collapse collapse">
        <div class="panel-body">
          <div id="transitLeg">
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- Right Column Map. -->
<div class="col-sm-9" id="map">
</div>

<script>
var start_stations = {{ starting_stations|safe }};
start_stations.sort(function(a, b) {
  return a.interspace - b.interspace;
});

var finish_stations = {{ finishing_stations|safe }};
finish_stations.sort(function(c, d) {
  return c.interspace - d.interspace;
});
//console.log(finish_stations);
var originalStartStation = start_stations[0];
// console.log(originalStartStation);

var originalFinishStation = finish_stations[0];

// console.log(originalFinishStation);


function getNewStartStation(){
  document.getElementById("collapse1").collapse;
  document.getElementById('bikeLeg1').innerHTML = "";
  document.getElementById('bikeLeg2').innerHTML = "";
  document.getElementById('bikeLeg3').innerHTML = "";
  document.getElementById('walkLeg').innerHTML = "";
  document.getElementById('transitLeg').innerHTML = "";
  // console.log(start_stations[0]);
  start_stations.shift();
  initMap();
}

function getNewFinishStation(){
  document.getElementById('bikeLeg1').innerHTML = "";
  document.getElementById('bikeLeg2').innerHTML = "";
  document.getElementById('bikeLeg3').innerHTML = "";
  document.getElementById('walkLeg').innerHTML = "";
  document.getElementById('transitLeg').innerHTML = "";
  // console.log(finish_stations[0]);
  finish_stations.shift();
  initMap();
}



function initMap() {
  var map = null;
  //console.log({{ starting_stations|safe }});
  //console.log({{ finishing_stations|safe }});
  var start = {lat: {{start_coordinates.lat}}, lng: {{start_coordinates.lng}}};
  var finish = {lat: {{finish_coordinates.lat}}, lng: {{finish_coordinates.lng}}};
  var start_station = start_stations[0];
  console.log(start_station);
  var finish_station = finish_stations[0];
  var start_station_coords = {lat: start_station.lat, lng: start_station.lng};
  // console.log(start_station_coords);
  var finish_station_coords = {lat: finish_station.lat, lng: finish_station.lng};
  // console.log(finish_station_coords);

  // Create a renderer for directions
  var directionsDisplay = new google.maps.DirectionsRenderer();
  // Create a map and center it on Start point.
  var mapOptions = {
                    zoom: 14,
                    center: start
                   };
  map = new google.maps.Map(document.getElementById('map'), mapOptions);
  directionsDisplay.setMap(map);

  var start_marker = new google.maps.Marker({
    position: start,
    map: map,
    icon: {
           path: google.maps.SymbolPath.CIRCLE,
           scale: 5,
           labelOrigin: new google.maps.Point(-6,0)
          },
    label: {
            text: 'Start',
            fontSize: "16px",
            fontWeight: "bold"
           }
  });

  var bike1_marker = new google.maps.Marker({
    position: start_station_coords,
    map: map,
    title: start_station.name + '\n Available Stands: '
            + start_station.available_bike_stands + '\n Available Bikes: '
            + start_station.available_bikes,
    label: {
            text: 'DB',
            fontSize: "16px",
            fontWeight: "bold"
           }
  });

  var bike2_marker = new google.maps.Marker({
    position: finish_station_coords,
    map: map,
    title: finish_station.name + '\n Available Stands: '
            + finish_station.available_bike_stands + '\n Available Bikes: '
            + finish_station.available_bikes,
    label: {
            text: 'DB',
            fontSize: "16px",
            fontWeight: "bold"
           }
  });

  var finish_marker = new google.maps.Marker({
    position: finish,
    map: map,
    icon: {
           path: google.maps.SymbolPath.CIRCLE,
           scale: 5,
           labelOrigin: new google.maps.Point(7,0)
          },
    label: {
            text: 'Finish',
            fontSize: "16px",
            fontWeight: "bold"
           }
  });

  var markers = [start_marker, bike1_marker, bike2_marker, finish_marker];
  markers[1].setVisible(false);
  markers[2].setVisible(false);

  // Instantiate directions services.
  var directionsService = new google.maps.DirectionsService();

  // Instantiate 5 directions renderers.
  var polyBike1 = new google.maps.DirectionsRenderer({suppressMarkers: true,
                                                      suppressBicyclingLayer: true,
                                                      polylineOptions: {
                                                          strokeColor: '#00B2BC'
                                                        }
                                                      });
  var polyBike2 = new google.maps.DirectionsRenderer({suppressMarkers: true,
                                                      suppressBicyclingLayer: true,
                                                      polylineOptions: {
                                                          strokeColor:'#E2790C'
                                                        }
                                                      });
  var polyBike3 = new google.maps.DirectionsRenderer({suppressMarkers: true,
                                                      suppressBicyclingLayer: true,
                                                      polylineOptions: {
                                                          strokeColor: '#00B2BC'
                                                        }
                                                      });
  var polyWalk = new google.maps.DirectionsRenderer({suppressMarkers: true,
                                                     suppressBicyclingLayer: true,
                                                     polylineOptions: {
                                                         strokeColor: '#00B2BC'
                                                        }
                                                    });

  var polyTransit = new google.maps.DirectionsRenderer({suppressMarkers: true,
                                                        suppressBicyclingLayer: true,
                                                        polylineOptions: {
                                                          strokeColor: ' #009900'
                                                         }
                                                       });


  // Draw Bikes on Map after Click
  document.getElementById("biking_button").addEventListener("click", renderBikes);
  document.getElementById("walking_button").addEventListener("click", renderWalk);
  document.getElementById("transit_button").addEventListener("click", renderTransit);

  if((originalStartStation !== start_station) || (originalFinishStation !== finish_station)){
    renderBikes();
  }

  function renderBikes() {
    document.getElementById("biking_button").removeEventListener("click", renderBikes);
    document.getElementById("transit_button").addEventListener("click", renderTransit);
    document.getElementById("walking_button").addEventListener("click", renderWalk);
    polyWalk.setMap(null);
    polyTransit.setMap(null);
    markers[1].setVisible(true);
    markers[2].setVisible(true);
    requestDirections(start, start_station_coords, 'WALKING', map, polyBike1 ,directionsService);
    requestDirections(start_station_coords, finish_station_coords,'BICYCLING', map, polyBike2, directionsService);
    requestDirections(finish, finish_station_coords, 'WALKING', map, polyBike3, directionsService);
  };

  // Draw Walking on Map after Click

  function renderWalk() {
    document.getElementById("walking_button").removeEventListener("click", renderWalk);
    document.getElementById("biking_button").addEventListener("click", renderBikes);
    document.getElementById("transit_button").addEventListener("click", renderTransit);
    polyBike1.setMap(null);
    polyBike2.setMap(null);
    polyBike3.setMap(null);
    polyTransit.setMap(null);
    markers[1].setVisible(false);
    markers[2].setVisible(false);
    requestDirections(start, finish, 'WALKING', map, polyWalk, directionsService);
  };


  // Draw Transit on Map after Click and get DistanceMatrixService
  function renderTransit() {
    document.getElementById("transit_button").removeEventListener("click", renderTransit);
    document.getElementById("biking_button").addEventListener("click", renderBikes);
    document.getElementById("walking_button").addEventListener("click", renderWalk);
    polyBike1.setMap(null);
    polyBike2.setMap(null);
    polyBike3.setMap(null);
    polyWalk.setMap(null);
    markers[1].setVisible(false);
    markers[2].setVisible(false);
    requestDirections(start, finish, 'TRANSIT', map, polyTransit, directionsService);
  }

  // Output Results to left column
  // First for Dublin Bikes Widget, then Walking
  var total_time = 0;
  // First calculate walk time from start to bike station
  function walkToBikeStation(start, start_station_coords){
    var time1 = 0;
    var service = new google.maps.DistanceMatrixService;
    service.getDistanceMatrix({
      origins: [start],
      destinations: [start_station_coords],
      travelMode: 'WALKING',
      unitSystem: google.maps.UnitSystem.METRIC,
      avoidHighways: false,
      avoidTolls: false
    }, function(response, status) {
        if (status !== 'OK')
        {
          alert('Error was: ' + status);
        }
          else
        {
          var originList = response.originAddresses;
          var shortOr = originList[0].split(',')[0];
          // console.log(shortOr);
          var destinationList = response.destinationAddresses;
          var shortDe = destinationList[0].split(',')[0];

          var outputDiv = document.getElementById('bikeLeg1');
          var results = response.rows[0].elements;
          // console.log(results);
          outputDiv.innerHTML += '<h5>&nbsp;&bull;  WALK</h5>' + shortOr +
                                 ' to ' + shortDe + '<br>&nbsp;&nbsp;' +
                                 '<strong>' + results[0].distance.text +
                                 ' in ' +
                                 results[0].duration.text + '</strong><br>';

          time1 = results[0].duration.value;
          total_time += time1;
          // Calculate time on bike
          bikeToBikeStation(start_station_coords, finish_station_coords);
      }
    });
  }
  // Calculate time on bike
  function bikeToBikeStation(start_station_coords, finish_station_coords){
    var time2 = 0;
    var service = new google.maps.DistanceMatrixService;
    service.getDistanceMatrix({
      origins: [start_station_coords],
      destinations: [finish_station_coords],
      travelMode: 'BICYCLING',
      unitSystem: google.maps.UnitSystem.METRIC,
      avoidHighways: false,
      avoidTolls: false
    },
    function(response, status) {
      if (status !== 'OK') {
        alert('Error was: ' + status);
      } else {
        var originList = response.originAddresses;
        var shortOr = originList[0].split(',')[0];
        var destinationList = response.destinationAddresses;
        var shortDe = destinationList[0].split(',')[0];
        var outputDiv = document.getElementById('bikeLeg2');
        var results = response.rows[0].elements;
        outputDiv.innerHTML += '<h5>&nbsp;&bull;  CYCLE</h5>' + shortOr +
                               ' to ' + shortDe + '<br>&nbsp;&nbsp;' +
                               '<strong>' + results[0].distance.text + ' in ' +
                               results[0].duration.text + '</strong><br>';

        outputDiv.innerHTML += '<br>' + 'Bike Pick Up: ' + start_station.name + '<br>'
                              + '&nbsp;&nbsp;Available Bikes: ' + start_station.available_bikes;
        if(start_station.available_bikes < 1) {

          outputDiv.innerHTML += '&nbsp;&nbsp;<button onclick="getNewStartStation()" type="button" class="btn btn-xs btn-dark">Change Station</button><br>';
        }

        outputDiv.innerHTML += '<br>Bike Return: ' + finish_station.name + '<br>'
                              + '&nbsp;&nbsp;Available Spaces: ' + finish_station.available_bike_stands;
        if(finish_station.available_bike_stands < 1) {
          outputDiv.innerHTML += '&nbsp;&nbsp;<button onclick="getNewFinishStation()" type="button" class="btn btn-xs btn-dark">Change Station</button><br>';
        }

        time2 = results[0].duration.value;
        total_time += time2;
        // Time from bike station to finish
        bikeStationToFinish(finish_station_coords, finish);
      }
    });
  }
  // Calculate last DB journey walk
  function bikeStationToFinish(finish_station_coords, finish){
    var time3 = 0;
    var service = new google.maps.DistanceMatrixService;
    service.getDistanceMatrix({
      origins: [finish_station_coords],
      destinations: [finish],
      travelMode: 'WALKING',
      unitSystem: google.maps.UnitSystem.METRIC,
      avoidHighways: false,
      avoidTolls: false
    },
    function(response, status) {
      if (status !== 'OK') {
        alert('Error was: ' + status);
      } else {
        var originList = response.originAddresses;
        var shortOr = originList[0].split(',')[0];
        var destinationList = response.destinationAddresses;
        var shortDe = destinationList[0].split(',')[0];
        var outputDiv = document.getElementById('bikeLeg3');
        var results = response.rows[0].elements;
        outputDiv.innerHTML += '<h5>&nbsp;&bull;  WALK</h5>' + shortOr +
                               ' to ' + shortDe + '<br>&nbsp;&nbsp;' +
                               '<strong>' + results[0].distance.text + ' in ' +
                               results[0].duration.text + '</strong><br>';

        time3 = results[0].duration.value;
        total_time += time3;
        var outputDiv2 = document.getElementById('totalBikeTime');
        outputDiv2.innerHTML = '&nbsp;&nbsp;' + Math.ceil(total_time/60) + ' ' + 'minutes';
      }
    });
  }
  // Call walk to bike station function (which then calls 2 more functions)
  walkToBikeStation(start, start_station_coords);

  // Output Walking Results
  function onlyWalking(start, finish){
    var service = new google.maps.DistanceMatrixService;
    service.getDistanceMatrix({
      origins: [start],
      destinations: [finish],
      travelMode: 'WALKING',
      unitSystem: google.maps.UnitSystem.METRIC,
      avoidHighways: false,
      avoidTolls: false
    },
    function(response, status) {
      if (status !== 'OK') {
        alert('Error was: ' + status);
      } else {
        var originList = response.originAddresses;
        var shortOr = originList[0].split(',')[0];
        var destinationList = response.destinationAddresses;
        var shortDe = destinationList[0].split(',')[0];
        var outputDiv = document.getElementById('walkLeg');
        var results = response.rows[0].elements;
        outputDiv.innerHTML += '<h5>&nbsp;&bull;  WALK</h5>' + shortOr + ' to ' + shortDe +
                          '<br>&nbsp;&nbsp;' + '<strong>' + results[0].distance.text + ' in ' +
                          results[0].duration.text + '</strong><br>';

        time4 = results[0].duration.value;
        var outputDiv2 = document.getElementById('totalWalkTime');
        outputDiv2.innerHTML = '&nbsp;&nbsp;' + Math.ceil(time4/60) + ' ' + 'minutes';
      }
    });

  }
  onlyWalking(start, finish);

  // Output Transit to left Column
  function calcTransit(start, finish){
    var request = {
      origin: start,
      destination: finish,
      travelMode: google.maps.DirectionsTravelMode.TRANSIT,
    };

    directionsService.route(request, function(response, status) {
      time4 = response.routes[0].legs[0].duration.value;
      var outputDiv2 = document.getElementById('totalTransitTime');
      outputDiv2.innerHTML = '&nbsp;&nbsp;' + Math.ceil(time4/60) + ' ' + 'minutes';
      var outputDiv = document.getElementById('transitLeg');
      outputDiv.innerHTML += '<h5>&nbsp;&bull;  TRANSIT</h5>'
      if (status == google.maps.DirectionsStatus.OK) {
        // Write directions steps
        //console.log(response.routes[0].legs[0].steps);
        stepLen = response.routes[0].legs[0].steps.length;
        //console.log(stepLen)
        for (i = 0; i < stepLen; i++) {
          //console.log(response.routes[0].legs[0].steps[i].distance.text);
          //console.log(response.routes[0].legs[0].steps[i].duration.text);
          //console.log(response.routes[0].legs[0].steps[i].instructions);
          outputDiv.innerHTML += response.routes[0].legs[0].steps[i].instructions +
                                  '<br>' + '&nbsp;&nbsp;<strong>'
                                  + response.routes[0].legs[0].steps[i].distance.text +
                                  ' in ' + response.routes[0].legs[0].steps[i].duration.text +
                                  '</strong><br>';
        }
      }
    });
  }
  calcTransit(start, finish);
}

</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbLnsQQH5RbYWL1mn1co79q5ov7TRjjU0&callback=initMap">
</script>
{% endblock %}
