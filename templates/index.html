{% extends "bootstrap/base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block styles %}
{{super()}}
<link rel="stylesheet" href="{{url_for('.static', filename='css/signin.css')}}">
{% endblock %}

{% if current_user.is_authenticated %}
    {% include 'navbar_logged_in.html' %}
  {% else %}
    {% include 'navbar_logged_out.html' %}
{% endif %}

{% block content %}
<body style="background-image: url(static/images/new1.v1.jpg);">
    <br>
    <br>
    <div class="container">

          <form class="form-signin" method="POST" action="/map">
            {{ form.hidden_tag() }}
            {{ wtf.form_field(form.start, id="search_start", placeholder="Where are you?",
                              onClick="this.select();") }}
            {{ wtf.form_field(form.finish, id="search_finish", placeholder="Where are you going?") }}
            <button class="btn btn-md btn-primary" type="submit">Let's Go</button>
          </form>

    </div>

</body>
<script>

  function activatePlacesSearch(){

    var input_start = document.getElementById('search_start');
    var current_lat = 0;
    var current_lng = 0;
    var formatted_ad = '';

    function showPosition(position) {
      console.log('B');
      // console.log(position.coords.latitude);
      current_lat = position.coords.latitude;
      current_lng = position.coords.longitude;
      // Convert to address
      var geocoder = new google.maps.Geocoder;
      var latlng = {lat: parseFloat(current_lat), lng: parseFloat(current_lng)};
      geocoder.geocode({'location': latlng}, function(results, status) {
          if (status === 'OK') {
            if (results[0]) {
              // console.log(results[0].formatted_address);
              var formatted_ad = results[0].formatted_address;
              document.getElementById('search_start').value = formatted_ad;
              console.log(formatted_ad);
            } else {
              window.alert('No results found');
              console.log(formatted_ad);
            }
          } else {
            window.alert('Geocoder failed due to: ' + status);
          }
        });
    }

    function errorHandler(err) {
            if(err.code == 1) {
               alert("Error: Access is denied!");
            }
            else if( err.code == 2) {
               alert("Error: Position is unavailable!");
            }
         }

    function getLocation() {
      console.log('A');
        if (navigator.geolocation) {
            var options = {timeout:60000};
            navigator.geolocation.getCurrentPosition(showPosition,  errorHandler, options);
        } else {
            input_start.innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    function detectmob() {
      if( navigator.userAgent.match(/Android/i)
      || navigator.userAgent.match(/iPhone/i)
      || navigator.userAgent.match(/Windows Phone/i)
      ){
        return true;
      }
      else {
        return false;
      }
    }
    if( detectmob() ) {
      getLocation();
  	} else {
      var input_start = document.getElementById('search_start');
      var autocomplete_start = new google.maps.places.Autocomplete(input_start);
      autocomplete_start.setComponentRestrictions(
              {'country': ['ie']});
    }

    var input_finish = document.getElementById('search_finish');
    var autocomplete_finish = new google.maps.places.Autocomplete(input_finish);
    autocomplete_finish.setComponentRestrictions(
            {'country': ['ie']});
  }
</script>
<script src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyCbLnsQQH5RbYWL1mn1co79q5ov7TRjjU0&callback=activatePlacesSearch"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
{% endblock %}
